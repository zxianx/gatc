# GATC 系统首版方案文档

## 1. 项目概述

GATC (Google Account Token Collector) 是一个自动化系统，用于管理废弃的Google Cloud账户，将其转换为可访问Gemini API的token。系统通过虚拟机管理和账户自动化流程，实现规模化的Google Cloud资源利用。

## 2. 系统架构设计

### 2.1 模块划分

#### 核心模块
- **service/vm**: 虚拟机管理服务
- **service/account**: GCP账户管理服务  
- **service/auth**: 认证交互服务
- **handler**: HTTP处理器
- **model**: 数据模型定义

#### 基础模块
- **base/zlog**: 日志系统
- **base/response**: 统一响应格式
- **conf**: 配置管理
- **helpers**: 工具函数

## 3. 数据库设计

### 3.1 虚拟机表 (vm_instances)
```sql
CREATE TABLE `vm_instances` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `vm_id` varchar(128) NOT NULL COMMENT 'VM实例ID',
  `vm_name` varchar(128) NOT NULL COMMENT 'VM名称',
  `zone` varchar(64) NOT NULL COMMENT '可用区',
  `machine_type` varchar(64) NOT NULL COMMENT '机器类型',
  `external_ip` varchar(45) DEFAULT NULL COMMENT '外部IP',
  `internal_ip` varchar(45) DEFAULT NULL COMMENT '内部IP',
  `proxy_port` int DEFAULT NULL COMMENT 'SOCKS5代理端口',
  `ssh_user` varchar(64) DEFAULT NULL COMMENT 'SSH用户名',
  `ssh_key_content` text COMMENT 'SSH私钥内容',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态: 1-运行中 2-已停止 3-已删除',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_vm_id` (`vm_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_updated_at` (`updated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='虚拟机实例表';
```

### 3.2 GCP账户表 (gcp_accounts)

按代码改动为准  

## 4. API接口设计

### 4.1 虚拟机管理接口

#### 4.1.1 创建虚拟机 (供开号流程测试用)
```
POST /api/v1/vm/create

Response:
{
    "code": 0,
    "message": "success",
    "data": {
        "vm_id": "vm-instance-12345",
        "external_ip": "34.123.45.67",
        "proxy_port": 1080,
        "ssh_connection": "ssh gatc@34.123.45.67"
    }
}
```

#### 4.1.2 删除虚拟机
```
DELETE /api/v1/vm/{vm_id}

Response:
{
    "code": 0,
    "message": "VM deleted successfully"
}
```

### 4.2 账户管理接口

#### 4.2.1 启动开号流程
```
POST /api/v1/account/start-provision
Content-Type: application/json

{
    "email": "user@example.com"
}

Response:
{
    "code": 0,
    "message": "Account provision started",
    "data": {
        "account_id": 123,
        "vm_id": "vm-instance-12345",
        "login_url": "https://accounts.google.com/o/oauth2/auth?...",
        "callback_url": "http://api.example.com/api/v1/account/auth-callback?req_id=req-auth-456&key={auth_code}"
    }
}
```

#### 4.2.2 认证回调
```
GET /api/v1/account/auth-callback?req_id=req-auth-456&key=4/0AdQt8qh...

Response:
{
    "code": 0,
    "message": "Authentication completed successfully"
}
```

#### 4.2.3 标记账户失效
```
POST /api/v1/account/mark-invalid
Content-Type: application/json

{
    "email": "user@example.com",
    "project_id": "project-12345"
}

Response:
{
    "code": 0,
    "message": "Account marked as invalid"
}
```

## 5. 核心流程设计

### 5.1 开号流程
1. 接收开号请求 (email)
2. 创建虚拟机并等待初始化完成
3. 在VM中执行 `gcloud auth login --no-launch-browser`
4. 返回认证URL和回调地址给用户
5. 用户手动完成认证并提交key
6. 完成gcloud登录
7. 创建/管理项目 (最多12个)
8. 绑定信用卡到项目
9. 生成Gemini API token
10. 保存所有信息到数据库

### 5.2 虚拟机初始化方案

推荐使用VM初始化脚本，在创建VM时通过startup-script安装必要环境。所有创建的VM使用同一个RSA密钥对，密钥生成在 `conf/gcp/gatc_rsa`：

```bash
#!/bin/bash
# VM初始化脚本

# 更新系统
apt-get update -y

# 安装基础工具
apt-get install -y curl wget unzip python3-pip

# 安装Google Cloud SDK
curl https://sdk.cloud.google.com | bash
source ~/.bashrc

# 安装并配置SOCKS5代理 (dante-server)
apt-get install -y dante-server
cat > /etc/danted.conf <<EOF
logoutput: syslog
internal: 0.0.0.0 port = 1080
external: eth0
clientmethod: none
socksmethod: none
user.privileged: root
user.unprivileged: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: error
}

socks pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: error
}
EOF

systemctl enable danted
systemctl start danted

# 创建标识文件表示初始化完成
touch /tmp/vm_init_complete
```

**SSH密钥管理**: 
- 程序启动时检查 `conf/gcp/gatc_rsa` 是否存在，不存在则生成
- 所有VM使用同一个公钥，私钥内容存储在数据库的 `ssh_key_content` 字段

### 5.3 异常处理流程
- **VM创建失败**: 记录错误，返回失败信息
- **认证失败**: 清理VM资源，标记账户状态
- **流程中断**: 删除创建的VM，避免资源浪费

## 6. 技术选型

### 6.1 后端技术栈
- **语言**: Go 1.22
- **Web框架**: Gin
- **ORM**: GORM
- **数据库**: MySQL 8.0
- **日志**: Zap
- **配置**: Yaml

### 6.2 外部依赖
- **Google Cloud SDK**: 在VM中安装
- **SOCKS5代理**: dante-server
- **Docker**: 容器化部署

## 7. 配置管理

### 7.1 应用配置 (conf.yaml)
```yaml
port: 8422
log:
  level: "info"
  output: "stdout"
```

### 7.2 程序常量定义
```go
const (
    // GCP配置
    WhiteAccountKeyPath = "./conf/gcp/sa-key0.json"
    DefaultZone        = "us-central1-a"
    DefaultMachineType = "e2-small"
    MaxProjectsPerAccount = 12
    VMInitScriptPath   = "./scripts/vm_init.sh"
    
    // SSH密钥配置
    SSHKeyPath         = "./conf/gcp/gatc_rsa"
    SSHPubKeyPath      = "./conf/gcp/gatc_rsa.pub"
)
```

### 7.3 数据库配置 (resource.yaml)
```yaml
mysql:
  iaas:
    user: "gatc_user"
    password: "gatc_password"
    addr: "localhost:3306"
    database: "gatc"
    max_idle_conns: 10
    max_open_conns: 100
```

## 8. 部署方案

### 8.1 Docker 部署
```dockerfile
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY . .
RUN go mod tidy && go build -o gatc main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates curl
WORKDIR /root/
COPY --from=builder /app/gatc .
COPY --from=builder /app/conf ./conf
COPY --from=builder /app/scripts ./scripts
CMD ["./gatc"]
```

### 8.2 docker-compose.yml
```yaml
version: '3.8'
services:
  gatc:
    build: .
    ports:
      - "8422:8422"
    volumes:
      - ./conf:/root/conf
    depends_on:
      - mysql
      
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: gatc
      MYSQL_USER: gatc_user 
      MYSQL_PASSWORD: gatc_password
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

## 9. 开发计划

### 9.1 第一期 (基础功能)
- [ ] 项目框架搭建
- [ ] 数据库设计和模型定义
- [ ] 虚拟机管理服务实现
- [ ] VM初始化脚本开发
- [ ] 基础API接口开发

### 9.2 第二期 (核心功能)
- [ ] GCP账户开号流程实现
- [ ] 交互式认证机制
- [ ] 项目和计费管理
- [ ] Token生成和管理
- [ ] Docker化部署

## 10. 总结

本方案提供了GATC系统的完整实现方案，采用简洁的模块化设计。通过VM初始化脚本简化环境配置，通过容器化部署提高系统的可移植性。

项目将采用两期迭代开发，优先实现虚拟机管理和基础API，然后完成核心的账户开号流程。重点关注实验性功能的快速实现和验证。